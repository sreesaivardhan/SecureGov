<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureGov - Digital Document Management</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///wAAAAA">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/family-dashboard.css">

  
</head>
<body>
    <!-- Header -->
    <div class="header">
        <nav class="nav">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                SecureGov
            </div>
        </nav>
    </div>

    <div class="container">
        <!-- Alerts -->
        <div id="alertContainer"></div>

        <!-- Login Screen -->
        <div id="loginScreen" class="main-content active">
            <div class="auth-container">
                <h2 class="auth-title">
                    <i class="fas fa-sign-in-alt"></i>
                    Login to SecureGov
                </h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" autocomplete="email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" autocomplete="current-password" required>
                    </div>
                    <button type="submit" class="btn">
                        <span id="loginBtnText">Login</span>
                        <div id="loginLoader" class="loading hidden"></div>
                    </button>
                </form>
                <div class="auth-switch">
                    Don't have an account? <a href="#" onclick="showScreen('registerScreen')">Register here</a>
                </div>
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="main-content">
            <div class="auth-container">
                <h2 class="auth-title">
                    <i class="fas fa-user-plus"></i>
                    Create Account
                </h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerName">Full Name</label>
                        <input type="text" id="registerName" autocomplete="name" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email Address</label>
                        <input type="email" id="registerEmail" autocomplete="email" readonly>
                    </div>
                    <div class="form-group">
                        <label for="registerPhone">Phone Number</label>
                        <input type="tel" id="registerPhone" autocomplete="tel" required>
                    </div>
                    <div class="form-group">
                        <label for="registerAadhaar">Aadhaar Number</label>
                        <input type="text" id="registerAadhaar" autocomplete="off" readonly>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" autocomplete="new-password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" autocomplete="new-password" required>
                    </div>
                    <button type="submit" class="btn">
                        <span id="registerBtnText">Create Account</span>
                        <div id="registerLoader" class="loading hidden"></div>
                    </button>
                </form>
                <div class="auth-switch">
                    Already have an account? <a href="#" onclick="showScreen('loginScreen')">Login here</a>
                </div>
            </div>
        </div>

        <!-- OTP Verification Screen -->
        <div id="otpScreen" class="main-content">
            <div class="auth-container">
                <h2 class="auth-title">
                    <i class="fas fa-mobile-alt"></i>
                    Verify OTP
                </h2>
                <p style="text-align: center; margin-bottom: 30px; color: #666;">
                    Enter the OTP sent to your email/phone
                </p>
                <form id="otpForm">
                    <div class="form-group">
                        <label for="otpCode">OTP Code</label>
                        <input type="text" id="otpCode" maxlength="6" pattern="[0-9]{6}" autocomplete="one-time-code" required>
                    </div>
                    <button type="submit" class="btn">
                        <span id="otpBtnText">Verify OTP</span>
                        <div id="otpLoader" class="loading hidden"></div>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resendOTP()">
                        Resend OTP
                    </button>
                </form>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="main-content">
            <div class="dashboard">
                <div class="sidebar">
                    <ul class="sidebar-menu">
                        <li><a href="#" onclick="showDashboardSection('overview')" class="active">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a></li>
                        <li><a href="#" onclick="showDashboardSection('documents')">
                            <i class="fas fa-file-alt"></i> My Documents
                        </a></li>
                        <li><a href="#" onclick="showDashboardSection('upload')">
                            <i class="fas fa-cloud-upload-alt"></i> Upload Document
                        </a></li>
                        <li><a href="#" onclick="showDashboardSection('family')">
                            <i class="fas fa-users"></i> Family Members
                        </a></li>
                        <li><a href="#" onclick="showDashboardSection('profile')">
                            <i class="fas fa-user-cog"></i> Profile
                        </a></li>
                        <li><a href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a></li>
                    </ul>
                </div>

                <div class="main-panel">
                    <!-- Dashboard Overview -->
                    <div id="overviewSection" class="dashboard-section active">
                        <div class="welcome-message">
                            <h2>Welcome to SecureGov Dashboard</h2>
                            <p>Manage your important government documents securely.</p>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="stat-title">Total Documents</div>
                                <div class="stat-value" id="totalDocs">0</div>
                                <div class="stat-label">documents</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-share-alt"></i>
                                </div>
                                <div class="stat-title">Shared Documents</div>
                                <div class="stat-value" id="sharedDocs">0</div>
                                <div class="stat-label">documents</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-title">Family Members</div>
                                <div class="stat-value" id="familyCount">0</div>
                                <div class="stat-label">members</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div class="stat-title">Pending Invitations</div>
                                <div class="stat-value" id="pendingInvitations">0</div>
                                <div class="stat-label">invitations</div>
                            </div>
                        </div>
                        
                    </div>

                    <!-- Documents Section -->
                    <div id="documentsSection" class="dashboard-section" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>My Documents</h2>
                            <button class="btn" style="width: auto; padding: 10px 20px;" onclick="showDashboardSection('upload')">
                                <i class="fas fa-plus"></i> Add Document
                            </button>
                        </div>
                        
                        <!-- Search and Filter Bar -->
                        <div class="search-filter-bar">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="documentSearch" placeholder="Search documents..." onkeyup="searchDocuments()">
                            </div>
                            <div class="filter-options">
                                <select id="categoryFilter" onchange="filterDocuments()">
                                    <option value="">All Categories</option>
                                    <option value="government">Government</option>
                                    <option value="personal">Personal</option>
                                    <option value="financial">Financial</option>
                                    <option value="medical">Medical</option>
                                    <option value="legal">Legal</option>
                                </select>
                                <select id="dateFilter" onchange="filterDocuments()">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="documentsGrid" class="document-grid">
                            <!-- Documents will be populated here -->
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div id="uploadSection" class="dashboard-section" style="display: none;">
                        <h2>Upload New Document</h2>
                        <form id="uploadForm">
                            <div class="upload-area" onclick="triggerFileInput()">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3>Click to upload or drag and drop</h3>
                                <p>PDF, JPG, PNG files only (Max 10MB)</p>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" style="display: none;" onchange="handleFileSelect(event)">
                            <div class="form-group">
                                <label for="docType">Document Type</label>
                                <select id="docType" autocomplete="off" required>
                                    <option value="">Select Document Type</option>
                                    <option value="aadhaar">Aadhaar Card</option>
                                    <option value="pan">PAN Card</option>
                                    <option value="passport">Passport</option>
                                    <option value="license">Driving License</option>
                                    <option value="marksheet">Mark Sheet</option>
                                    <option value="certificate">Certificate</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="docName">Document Name</label>
                                <input type="text" id="docName" placeholder="e.g., My Aadhaar Card" autocomplete="off" required>
                            </div>
                            <div class="form-group">
                                <label for="docDescription">Description (Optional)</label>
                                <input type="text" id="docDescription" placeholder="Additional details about the document" autocomplete="off">
                            </div>
                            <button type="submit" class="btn">
                                <span id="uploadBtnText">Upload Document</span>
                                <div id="uploadLoader" class="loading hidden"></div>
                            </button>
                        </form>
                    </div>

                    <!-- Shared Documents Section (Hidden by default) -->
                    <div id="sharedSection" class="dashboard-section" style="display: none;">
                        <h2>Shared Documents</h2>
                        <div id="sharedGrid" class="document-grid">
                            <p>Use the dedicated Documents page to view shared documents.</p>
                        </div>
                    </div>

                    <!-- Family Section -->
                    <div id="familySection" class="dashboard-section" style="display: none;">
                        <div class="family-header">
                            <h2>Family Members</h2>
                            <button class="btn btn-primary" onclick="showInviteModal()">
                                <i class="fas fa-plus"></i> Invite Family Member
                            </button>
                        </div>
                        
                        <div id="familyMembersList" class="family-members-list">
                            <!-- Family members will be loaded here -->
                        </div>
                        
                        <div id="pendingInvitationsList" class="pending-invitations">
                            <!-- Pending invitations will be loaded here -->
                        </div>
                    </div>

                    <!-- Profile Section -->
                    <div id="profileSection" class="dashboard-section" style="display: none;">
                        <h2>My Profile</h2>
                        <form id="profileForm" class="profile-form" onsubmit="event.preventDefault(); saveUserProfile();">
                            <div class="form-group">
                                <label for="profileName">Full Name</label>
                                <input type="text" id="profileName" required>
                            </div>
                            <div class="form-group">
                                <label for="profileEmail">Email</label>
                                <input type="email" id="profileEmail" readonly>
                            </div>
                            <div class="form-group">
                                <label for="profilePhone">Phone Number</label>
                                <input type="tel" id="profilePhone">
                            </div>
                            <div class="form-group">
                                <label for="profileAddress">Address</label>
                                <textarea id="profileAddress" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn">Update Profile</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Modals -->
    <!-- Document Viewer Modal -->
    <div id="documentViewerModal" class="modal">
        <div class="modal-content document-viewer">
            <div class="modal-header">
                <h3 id="documentViewerTitle">Document Viewer</h3>
                <button class="close-modal" onclick="hideModal('documentViewerModal')">&times;</button>
            </div>
            <div class="document-viewer-content">
                <div class="document-viewer-toolbar">
                    <button class="btn-secondary" onclick="downloadCurrentDocument()">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button class="btn-secondary" onclick="hideModal('documentViewerModal')">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                <div class="document-preview" id="documentPreview">
                    <!-- Document content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Family Invitation Modal -->
    <div id="inviteFamilyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Invite Family Member</h3>
                <button class="close-modal" onclick="hideInviteModal()">&times;</button>
            </div>
            <form id="inviteFamilyForm">
                <div class="form-group">
                    <label for="inviteMemberName">Full Name *</label>
                    <input type="text" id="inviteMemberName" name="memberName" required placeholder="Enter full name">
                </div>
                
                <div class="form-group">
                    <label for="inviteEmail">Email Address *</label>
                    <input type="email" id="inviteEmail" name="email" required autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="memberRelationship">Relationship *</label>
                    <select id="memberRelationship" name="relationship" required>
                        <option value="">Select relationship</option>
                        <option value="spouse">Spouse</option>
                        <option value="parent">Parent</option>
                        <option value="child">Child</option>
                        <option value="sibling">Sibling</option>
                        <option value="grandparent">Grandparent</option>
                        <option value="grandchild">Grandchild</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideInviteModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Invitation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- Firebase Configuration -->
<script>
// Check if firebase-config.js exists, if not create minimal config
if (typeof firebase === 'undefined') {
    console.warn('Firebase not loaded properly');
}
</script>
<script src="js/firebase-config.js" onerror="console.warn('Firebase config file not found')"></script>

    <script src="js/config.js"></script>
    <script src="js/errorHandler.js"></script>
    <script src="js/performance.js"></script>
    <script src="js/dashboard-counts.js"></script>
    <script src="js/app.js"></script>
    <script src="js/advanced-features.js"></script>
</body>
</html>

    <script>
            // Load dashboard data including family information
            async function loadDashboardData() {
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    const token = await user.getIdToken();
                    
                    // Load family members and count
                    const familyResponse = await fetch('http://localhost:5000/api/family/count', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (familyResponse.ok) {
                        const familyData = await familyResponse.json();
                        if (familyData.success) {
                            updateFamilyStats(familyData.count);
                        }
                    }
                    
                    // Load pending invitations
                    const invitationsResponse = await fetch('http://localhost:5000/api/family/invitations', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (invitationsResponse.ok) {
                        const invitationsData = await invitationsResponse.json();
                        if (invitationsData.success) {
                            // Filter for pending invitations for current user
                            const pendingInvitations = invitationsData.invitations.filter(inv => 
                                inv.email === user.email && inv.status === 'pending'
                            );
                            updateInvitationStats(pendingInvitations);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                }
            }
            
            function updateFamilyStats(memberCount) {
                const familyCountElement = document.getElementById('familyCount');
                if (familyCountElement) {
                    familyCountElement.textContent = memberCount || 0;
                } else {
                    console.log('familyCount element not found, skipping stats update');
                }
            }
            
            function updateInvitationStats(invitations) {
                const pendingInvitationsElement = document.getElementById('pendingInvitations');
                if (pendingInvitationsElement) {
                    pendingInvitationsElement.textContent = invitations.length;
                } else {
                    console.log('pendingInvitations element not found, skipping stats update');
                }
                
                // Highlight invitation card if there are pending invitations
                if (invitations.length > 0) {
                    const invitationCard = document.querySelector('.stat-card.clickable');
                    if (invitationCard) {
                        invitationCard.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                        invitationCard.style.color = 'white';
                        const iconElement = invitationCard.querySelector('.stat-icon');
                        if (iconElement) {
                            iconElement.style.color = 'white';
                        }
                    }
                }
            }
            
            function displayFamilyGroupsPreview(memberCount) {
                // This function is no longer needed since we're showing member count instead of groups
                console.log('Family members count updated:', memberCount);
            }
            
            function getUserRole(group) {
                const user = firebase.auth().currentUser;
                if (!user) return 'unknown';
                
                const member = group.members?.find(m => m.userId === user.uid && m.status === 'active');
                return member ? member.role : 'unknown';
            }
            
            // Load dashboard data when user is authenticated
            firebase.auth().onAuthStateChanged((user) => {
                if (user && document.getElementById('dashboardScreen').style.display !== 'none') {
                    loadDashboardData();
                }
            });
        </script>
    
</body>
</html>